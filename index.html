<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Ticket Dashboard</title> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS Global Reset and Body */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 50px; /* Added padding to make space for footer */
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
            position: relative;
            border-bottom: 4px solid rgba(255, 255, 255, 0.3);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.5;
        }

        .header h1 {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 12px;
            text-shadow: 2px 4px 8px rgba(0, 0, 0, 0.3);
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            font-weight: 300;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* Tabs Navigation */
        .tabs {
            display: flex;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
            padding: 0 30px;
            overflow-x: auto;
            border-bottom: 2px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 18px 24px;
            font-size: 0.95em;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
        }

        .tab-btn i {
            margin-right: 8px;
            transition: transform 0.3s ease;
        }

        .tab-btn:hover {
            color: #667eea;
            background: linear-gradient(to bottom, rgba(102, 126, 234, 0.08), rgba(102, 126, 234, 0.15));
            transform: translateY(-2px);
        }

        .tab-btn:hover i {
            transform: scale(1.2);
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
            box-shadow: 0 -2px 8px rgba(102, 126, 234, 0.15);
        }

        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.4s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Filter Controls --- */
        .filter-controls-container {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        
        .filter-inputs {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-inputs input[type="text"],
        .filter-inputs select {
            padding: 12px 18px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            min-height: 44px;
            background: white;
        }

        .filter-inputs input[type="text"]:focus,
        .filter-inputs select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-inputs input[type="date"] {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.95em;
            max-width: 160px;
            min-height: 44px;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-inputs input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-inputs button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 44px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .filter-inputs button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .filter-inputs button:active {
            transform: translateY(0);
        }

        /* Stats & Charts Layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px;
        }
        
        #app-overall-stats-gt4u > .stats-grid,
        #app-overall-stats-jiracloud > .stats-grid,
        #app-overall-stats-jiracbe > .stats-grid,
        #app-overall-stats-clickup > .stats-grid {
            grid-template-columns: repeat(5, 1fr);
        }

        .pending-apps-grid, .circuit-apps-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Card Styles */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 28px;
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
            min-height: 140px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transition: transform 0.5s ease;
        }

        .stat-card:hover::before {
            transform: translate(-25%, -25%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.35);
        }
        
        #app-overall-stats-gt4u .stat-card,
        #app-overall-stats-jiracloud .stat-card,
        #app-overall-stats-jiracbe .stat-card,
        #app-overall-stats-clickup .stat-card {
             grid-column: span 1 !important;
        }

        .pending-card {
            padding: 28px;
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .pending-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            transition: transform 0.5s ease;
        }

        .pending-card:hover::before {
            transform: translate(-25%, -25%);
        }

        .pending-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }
        
        .circuit-card { 
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #2d3748;
            border: 2px solid;
        }

        .circuit-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .circuit-card.gt4u { background: linear-gradient(135deg, #E6E9F0 0%, #F5F7FA 100%); border-color: #667eea; }
        .circuit-card.jiracloud { background: linear-gradient(135deg, #FFF6E8 0%, #FFFAF0 100%); border-color: #f7a518; }
        .circuit-card.jiracbe { background: linear-gradient(135deg, #E8FFFA 0%, #F0FFFC 100%); border-color: #38f9d7; }
        .circuit-card.clickup { background: linear-gradient(135deg, #F2EBF5 0%, #FAF5FC 100%); border-color: #764ba2; }

        .circuit-card h4 {
            font-size: 1.25em;
            padding-bottom: 8px;
            margin-bottom: 12px;
            border-bottom: 3px solid;
            font-weight: 700;
        }
        
        .circuit-card.gt4u h4 { color: #667eea; border-bottom-color: #667eea; }
        .circuit-card.jiracloud h4 { color: #f7a518; border-bottom-color: #f7a518; }
        .circuit-card.jiracbe h4 { color: #38f9d7; border-bottom-color: #38f9d7; }
        .circuit-card.clickup h4 { color: #764ba2; border-bottom-color: #764ba2; }

        .circuit-total {
            font-size: 2.8em;
            font-weight: 800;
            margin-bottom: 18px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .circuit-card.gt4u .circuit-total { color: #667eea; }
        .circuit-card.jiracloud .circuit-total { color: #f7a518; }
        .circuit-card.jiracbe .circuit-total { color: #38f9d7; }
        .circuit-card.clickup .circuit-total { color: #764ba2; }
        
        .circuit-service-list {
            list-style-type: none;
            padding: 0;
            font-size: 0.92em;
        }
        
        .circuit-service-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.1);
            transition: background 0.2s ease;
        }

        .circuit-service-list li:hover {
            background: rgba(255, 255, 255, 0.5);
            padding-left: 8px;
            margin: 0 -8px;
        }

        .circuit-service-list li:last-child {
            border-bottom: none;
        }

        .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);}
        .stat-card.open { background: linear-gradient(135deg, #ffc107 0%, #f7a518 100%);}
        .stat-card.progress { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);}
        .stat-card.closed { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);}
        .stat-card.percentage { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);}

        .stat-label {
            font-size: 0.88em;
            opacity: 0.95;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            line-height: 1.3;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .stat-value {
            font-size: 2.8em;
            font-weight: 800;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            border-color: #667eea;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
        }

        .chart-title {
            font-size: 1.15em;
            font-weight: 700;
            margin-bottom: 18px;
            color: #2d3748;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chart-title i {
            color: #667eea;
            font-size: 1.2em;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-charts-grid, .sla-charts-grid { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }
        
        .sla-charts-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .tickets-table-container {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            border: 2px solid #f0f0f0;
            overflow-x: auto;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 24px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
        }

        .section-title i {
            color: #667eea;
            font-size: 1.1em;
        }

        /* Table Styles */
        .tickets-table { 
            width: 100%;
            border-collapse: collapse; 
            font-size: 0.95em;
        }
        
        .tickets-table thead { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tickets-table th { 
            padding: 16px;
            text-align: left; 
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 0.85em; 
            letter-spacing: 0.8px;
        }
        
        .tickets-table td { 
            padding: 16px;
            border-bottom: 1px solid #e9ecef; 
            vertical-align: top;
        }
        
        .tickets-table tbody tr { 
            transition: all 0.2s ease;
        }
        
        .tickets-table tbody tr:nth-child(even) { 
            background: #f8f9fa;
        }
        
        .clickable-row:hover { 
            cursor: pointer;
            background: linear-gradient(to right, #e9ecef 0%, #f8f9fa 100%);
            transform: scale(1.005);
        }
        
        .clickable-row.active-row { 
            background: linear-gradient(to right, #e3f2fd 0%, #f0f8ff 100%);
            font-weight: 600;
            border-left: 4px solid #667eea;
        }
        
        /* NEW: Nested Child Row Styles for Dashboard */
        .tickets-table tbody tr.nested-child-row {
             background: #f0f8ff; /* Lightest blue */
             color: #4a5568;
             border-left: 4px solid #667eea;
        }
        .tickets-table tbody tr.nested-child-row:hover {
             background: #e3f2fd !important; /* Keep a distinct color on hover */
             transform: none;
        }

        /* NEW: Ticket Details Row Style */
        .detail-row {
            background: #e3f2fd;
            animation: slideDown 0.3s ease-out;
        }

        .detail-row td {
            padding: 20px 30px !important;
            border-top: 3px solid #667eea;
            border-bottom: 2px solid #667eea;
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.05);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }


        /* Status/Priority/Service Badges */
        .status-badge { 
            display: inline-block;
            padding: 7px 14px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-open { background: #fef3c7; color: #92400e; }
        .status-progress { background: #dbeafe; color: #1e40af; }
        .status-closed { background: #d1fae5; color: #065f46; }
        
        .priority-badge { 
            display: inline-block;
            padding: 7px 14px; 
            border-radius: 20px; 
            font-size: 0.8em; 
            font-weight: 700; 
            text-transform: uppercase; 
            margin-left: 6px;
            letter-spacing: 0.5px;
        }
        .priority-high { background: #fee2e2; color: #b91c1c; }
        .priority-medium { background: #fef3c7; color: #92400e; }
        .priority-low { background: #dbeafe; color: #1e40af; }
        
        .servicetype-badge { 
             display: inline-block;
             padding: 7px 14px; 
             border-radius: 8px; 
             font-size: 0.8em; 
             font-weight: 700; 
             text-transform: uppercase; 
             margin-right: 6px;
             letter-spacing: 0.5px;
        }
        .servicetype-Problem { background: #dc3545; color: white; }
        .servicetype-Request { background: #ffc107; color: #343a40; }
        .servicetype-Information { background: #17a2b8; color: white; }

        /* Ticket Details Container (within the detail-row td) */
        .ticket-details-container {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            margin: 8px 0;
        }

        .details-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .details-content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item strong {
            font-size: 0.85em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item span {
            font-size: 1em;
            color: #2d3748;
            font-weight: 600;
        }
        
        /* Style for Child list in Parent details */
        .detail-item ul {
            padding-left: 15px !important;
        }
        .detail-item ul li {
            padding: 4px 0;
            border-bottom: 1px dotted #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .detail-item ul li:last-child {
             border-bottom: none;
        }
        
        /* --- NEW: Progressive Timeline History Styles --- */
        .timeline-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #2d3748;
            margin-top: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .timeline-container {
            margin-top: 15px;
            position: relative;
            padding-left: 25px;
        }

        .timeline-container::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            bottom: 5px;
            width: 2px;
            background-color: #667eea;
        }

        .timeline-item {
            margin-bottom: 15px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: white;
            border: 2px solid #667eea;
        }

        .timeline-time {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .timeline-action {
            font-weight: 600;
            color: #2d3748;
        }
        
        .timeline-user {
            font-size: 0.9em;
            color: #764ba2;
        }


        /* NEW Footer Style */
        .footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            color: #ffffff;
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .dashboard-layout { grid-template-columns: 1fr; }
            .stats-grid, .app-charts-grid, .pending-apps-grid, .circuit-apps-grid, .sla-charts-grid { 
                grid-template-columns: repeat(2, 1fr);
            }
            
            #app-overall-stats-gt4u > .stats-grid,
            #app-overall-stats-jiracloud > .stats-grid,
            #app-overall-stats-jiracbe > .stats-grid,
            #app-overall-stats-clickup > .stats-grid {
                 grid-template-columns: repeat(2, 1fr);
            }
            #app-overall-stats-gt4u .stat-card,
            #app-overall-stats-jiracloud .stat-card,
            #app-overall-stats-jiracbe .stat-card,
            #app-overall-stats-clickup .stat-card {
                 grid-column: span 1 !important;
            }
        }

        @media (max-width: 768px) {
            .stats-grid, .pending-apps-grid, .circuit-apps-grid, .sla-charts-grid { 
                grid-template-columns: 1fr;
            }
            .filter-inputs { 
                flex-direction: column;
                gap: 10px; 
            }
            .filter-inputs button { 
                min-width: 100%;
            }
            
            #app-overall-stats-gt4u > .stats-grid,
            #app-overall-stats-jiracloud > .stats-grid,
            #app-overall-stats-jiracbe > .stats-grid,
            #app-overall-stats-clickup > .stats-grid {
                 grid-template-columns: 1fr;
            }
             #app-overall-stats-gt4u .stat-card,
            #app-overall-stats-jiracloud .stat-card,
            #app-overall-stats-jiracbe .stat-card,
            #app-overall-stats-clickup .stat-card {
                 grid-column: span 1 !important;
            }

            .header h1 {
                font-size: 2em;
            }

            .header p {
                font-size: 1em;
            }
        }
    </style>
    </head>
<body>
    <div class="container">
        
        <div class="header">
            <h1>🎫 Unified Ticket Dashboard</h1>
            <p>Ticket monitoring and analysis across all applications</p>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'dashboard-search')"><i class="fas fa-search"></i> Dashboard</button>
            <button class="tab-btn" onclick="openTab(event, 'relationships')"><i class="fas fa-project-diagram"></i> Parent-Child Relationship</button>
            <button class="tab-btn" onclick="openTab(event, 'gt4u')">GT4U</button>
            <button class="tab-btn" onclick="openTab(event, 'jira-cloud')">JIRA (CLOUD HM)</button>
            <button class="tab-btn" onclick="openTab(event, 'jira-cbe')">JIRA (CBE)</button>
            <button class="tab-btn" onclick="openTab(event, 'clickup')">ClickUp (BNG)</button>
        </div>

        <div id="dashboard-search" class="tab-content active">
            
            <h2 class="section-title" id="circuit-summary-title" style="margin-top: 0px; display: none;">
                <i class="fas fa-plug"></i> Circuit & Service Summary for <span id="current-customer-name" style="color: #f5576c;">Customer</span>
            </h2>
            <div id="circuit-summary-section" style="display: none;">
            </div>
            <div class="filter-controls-container">
                <h2 class="section-title"><i class="fas fa-search"></i> Universal Ticket Explorer (ค้นหา ticket ทั้งหมด)</h2>
                <div class="filter-inputs">
                    <input type="text" id="universalSearch" placeholder="ค้นหาด้วย ID, Subject, หรือชื่อบริษัท (เช่น Customer A)" style="flex-grow: 4;"/> 
                    <select id="appFilter" style="flex-grow: 2;">
                        <option value="all">ทุก Application</option>
                        <option value="gt4u">GT4U</option>
                        <option value="jira-cloud">JIRA (CLOUD HM)</option>
                        <option value="jira-cbe">JIRA (CBE)</option>
                        <option value="clickup">ClickUp (BNG)</option>
                    </select>
                    <input type="date" id="startDate" style="flex-grow: 1; max-width: 150px;" title="จากวันที่เริ่มต้น" />
                    <input type="date" id="endDate" style="flex-grow: 1; max-width: 150px;" title="ถึงวันที่สิ้นสุด" />
                    <button id="resetAllTicketsBtn" onclick="resetDashboard()" style="flex-grow: 0; min-width: 80px; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                        <i class="fas fa-redo"></i> รีเซ็ต
                    </button>
                    <button id="searchAllTicketsBtn" onclick="filterAllTickets()" style="flex-grow: 0; min-width: 100px;">
                        <i class="fas fa-search"></i> ค้นหา Ticket
                    </button>
                </div>
            </div>
            
            <div class="master-ticket-table-container" style="display: none;">
                <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-list-ul"></i> ผลลัพธ์ Ticket ที่ค้นหา</h2>
                <table class="tickets-table master-ticket-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Subject</th>
                            <th>Company Name</th>
                            <th>Application</th>
                            <th>Service Type</th> 
                            <th>Status</th>
                            <th>Priority</th>
                            <th>ความสัมพันธ์</th> 
                        </tr>
                    </thead>
                    <tbody id="universalTicketTableBody"></tbody>
                </table>
            </div>

            <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-tachometer-alt"></i> Overall Ticket Summary Dashboard (All Apps)</h2>
            <div id="overall-stats-content"></div>
            
            <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-hourglass-half"></i> Pending Tickets Summary (Open + In Progress)</h2>
            <div class="pending-apps-grid" id="pending-ticket-summary"></div>
            
            <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-chart-area"></i> Application Performance Charts</h2>
            <div class="app-charts-grid">
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-ticket-alt"></i> Ticket Count by Application</h2>
                    <div class="chart-wrapper"><canvas id="ticketCountChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-check-circle"></i> Overall SLA Success Rate</h2>
                    <div class="chart-wrapper"><canvas id="overallSlaPieChart"></canvas></div>
                </div>
            </div>
            
            <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-check-circle"></i> SLA Success Rate (4 Hrs.) % By Application</h2>
            <div class="sla-charts-grid" id="sla-pie-charts-section"></div>
            
            <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-project-diagram"></i> Overall Relationship Summary</h2>
            <div class="app-charts-grid" id="dashboard-relationship-charts" style="grid-template-columns: repeat(2, 1fr);">
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-chart-pie"></i> Parent Ticket Origin</h2>
                    <div class="chart-wrapper"><canvas id="dashboardParentTicketChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-chart-bar"></i> Child Ticket Distribution</h2>
                    <div class="chart-wrapper"><canvas id="dashboardChildDistributionChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="relationships" class="tab-content">
            <h2 class="section-title"><i class="fas fa-project-diagram"></i> Parent-Child Relationship (Detailed View)</h2>
            
            <div class="filter-controls-container">
                <h2 class="section-title"><i class="fas fa-search"></i> ค้นหา Parent Ticket</h2>
                <div class="filter-inputs">
                    <input type="text" id="relationshipSearch" placeholder="ค้นหาด้วย ID หรือ Subject ของ Parent Ticket" style="flex-grow: 2;"/>
                    <select id="relationshipAppFilter">
                        <option value="all">ทุก Application</option>
                        <option value="gt4u">GT4U</option>
                        <option value="jira-cloud">JIRA (CLOUD HM)</option>
                        <option value="jira-cbe">JIRA (CBE)</option>
                        <option value="clickup">ClickUp (BNG)</option>
                    </select>
                    <input type="date" id="relationshipStartDate" style="max-width: 150px;" title="จากวันที่เริ่มต้น" />
                    <input type="date" id="relationshipEndDate" style="max-width: 150px;" title="ถึงวันที่สิ้นสุด" />
                    <button onclick="filterRelationshipTable()" style="min-width: 100px;">
                        <i class="fas fa-search"></i> ค้นหา
                    </button>
                    <button onclick="resetRelationshipFilter()" style="min-width: 80px; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                        <i class="fas fa-redo"></i> รีเซ็ต
                    </button>
                </div>
            </div>

            <div class="relationships-table-container">
                <h2 class="section-title"><i class="fas fa-sitemap"></i> Parent-Child Relationship Map</h2>
                <table class="tickets-table" id="relationships-main-table">
                    <thead>
                        <tr>
                            <th>Parent Ticket (Click for Detail)</th>
                            <th>Service Type</th>
                            <th>Status / Priority</th>
                            <th>Child Tickets (Click ID to view)</th>
                        </tr>
                    </thead>
                    <tbody id="relationships-table-body"></tbody>
                </table>
            </div>

            <h2 class="section-title" style="margin-top: 30px;"><i class="fas fa-chart-area"></i> Relationship Charts Summary</h2>
            <div class="app-charts-grid" id="relationship-charts-summary" style="grid-template-columns: repeat(2, 1fr);">
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-chart-pie"></i> Parent Ticket Origin</h2>
                    <div class="chart-wrapper"><canvas id="relationshipParentTicketChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title"><i class="fas fa-chart-bar"></i> Child Ticket Distribution</h2>
                    <div class="chart-wrapper"><canvas id="relationshipChildDistributionChart"></canvas></div>
                </div>
            </div>
            
        </div>

        <div id="gt4u" class="tab-content"></div>
        <div id="jira-cloud" class="tab-content"></div>
        <div id="jira-cbe" class="tab-content"></div>
        <div id="clickup" class="tab-content"></div>
    </div>
    
    <div class="footer">
        &copy; 2025 Unified Ticket Dashboard. All Rights Reserved. | Data Simulated for Demonstration Purposes.
    </div>

    <script>
        let chartInstances = {};
        let relationshipMap = {}; // Global map for quick relationship lookup

        const chartColors = {
            gt4u: '#667eea',
            jiracloud: '#f7a518',
            jiracbe: '#38f9d7',
            clickup: '#764ba2',
            open: '#ffc107',
            progress: '#f5576c',
            closed: '#28a745',
            slaSuccess: '#28a745',
            slaFailure: '#dc3545',
        };
        const slaColorsByApp = {
            gt4u: { success: '#4facfe', failure: '#6c757d' },
            jiracloud: { success: '#ff9800', failure: '#dc3545' },
            jiracbe: { success: '#00bcd4', failure: '#ffc107' },
            clickup: { success: '#9c27b0', failure: '#f5576c' },
        };
        const pendingColors = {
            gt4u: 'linear-gradient(135deg, #0093E9 0%, #80D0C7 100%)',
            'jira-cloud': 'linear-gradient(135deg, #FE6E00 0%, #FFCC70 100%)',
            'jira-cbe': 'linear-gradient(135deg, #1C92D2 0%, #F2FCFE 100%)',
            clickup: 'linear-gradient(135deg, #A4508B 0%, #5F0A87 100%)',
        };
        const applicationNames = {
            'gt4u': 'GT4U (Connecting)',
            'jira-cloud': 'JIRA (CLOUD HM)',
            'jira-cbe': 'JIRA (CBE)',
            'clickup': 'ClickUp (BNG)'
        };
        const circuitSummaryData = {
            'Customer A': {
                'gt4u': { appName: 'Connecting', total: 10, service: { 'MPLS': 4, 'Internet': 5, 'VAS': 1 } },
                'jira-cloud': { appName: 'CLOUD HM', total: 5, service: { 'Cloud VM': 3, 'Fortigate': 2, 'Load Balancer': 0 } },
                'jira-cbe': { appName: 'CBE (Security)', total: 3, service: { 'Firewall Audit': 2, 'WAF Deployment': 0, 'Vulnerability Scan': 1 } },
                'clickup': { appName: 'BNG (Brainergy)', total: 4, service: { 'ERP Module A': 3, 'CRM Customization': 0, 'App Integration': 1, 'Training': 0 } }
            },
            'Customer B': {
                'gt4u': { appName: 'Connecting', total: 5, service: { 'MPLS': 1, 'Internet': 4, 'VAS': 0 } },
                'jira-cloud': { appName: 'CLOUD HM', total: 2, service: { 'Cloud VM': 1, 'Fortigate': 0, 'Load Balancer': 1 } },
                'jira-cbe': { appName: 'CBE (Security)', total: 1, service: { 'Firewall Audit': 0, 'WAF Deployment': 1, 'Vulnerability Scan': 0 } },
                'clickup': { appName: 'BNG (Brainergy)', total: 6, service: { 'ERP Module A': 0, 'CRM Customization': 4, 'App Integration': 0, 'Training': 2 } }
            },
            'Customer C': {
                'gt4u': { appName: 'Connecting', total: 3, service: { 'MPLS': 1, 'Internet': 1, 'VAS': 1 } },
                'jira-cloud': { appName: 'CLOUD HM', total: 3, service: { 'Cloud VM': 1, 'Fortigate': 1, 'Load Balancer': 1 } },
                'jira-cbe': { appName: 'CBE (Security)', total: 5, service: { 'Firewall Audit': 3, 'WAF Deployment': 1, 'Vulnerability Scan': 1 } },
                'clickup': { appName: 'BNG (Brainergy)', total: 2, service: { 'ERP Module A': 1, 'CRM Customization': 0, 'App Integration': 1, 'Training': 0 } },
            },
            'All Customers (รวมทุกบริษัท)': { /* Placeholder for Grand Total */ }
        };
        
        // --- DATA with SID, CID, and TIMELINE ---
        const masterTicketData = [
            { id: 'GT-0987', sid: 'SID-83749201', cid: 'CID-583921', subject: 'Major Service Outage - East Region', status: 'progress', serviceType: 'Problem', priority: 'high', company: 'Customer A', application: 'gt4u', relationship: 'Parent', date: '2025-09-29 09:00', isParent: true, isChild: false, closedTime: null, slaSuccess: false, description: 'Service went down for 4 hours. Root cause analysis initiated.', timeline: [
                { date: '2025-09-29 09:05', user: 'Monitoring System', action: 'Ticket automatically created from alert.'},
                { date: '2025-09-29 09:15', user: 'S. J.', action: 'Assigned ticket to Network Team. Status changed to In Progress.'},
                { date: '2025-09-29 11:30', user: 'N. T.', action: 'Initial investigation points to a core router failure.'}
            ]},
            { id: 'GT-1011', sid: 'SID-23948105', cid: 'CID-234512', subject: 'Schema Update for new DB version', status: 'progress', serviceType: 'Request', priority: 'medium', company: 'Customer B', application: 'gt4u', relationship: 'Standard', date: '2025-10-01 10:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Request for DB schema update as per new requirements.', timeline: [
                { date: '2025-10-01 10:00', user: 'Customer B Portal', action: 'Ticket created by customer.'},
                { date: '2025-10-01 10:20', user: 'A. P.', action: 'Request acknowledged. Pending developer availability.'}
            ]},
            { id: 'GT-1012', sid: 'SID-23948105', cid: 'CID-234512', subject: 'API connection refactor', status: 'open', serviceType: 'Request', priority: 'medium', company: 'Customer B', application: 'gt4u', relationship: 'Standard', date: '2025-10-01 14:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Refactoring of connection layer for new API Gateway integration.', timeline: [
                { date: '2025-10-01 14:00', user: 'Internal Request', action: 'Ticket opened for scheduled maintenance.'}
            ]},
            { id: 'GT-1018', sid: 'SID-45678901', cid: 'CID-887432', subject: 'Critical Vulnerability Fix (GT4U)', status: 'closed', serviceType: 'Problem', priority: 'high', company: 'Customer C', application: 'gt4u', relationship: 'Child', date: '2025-09-30 08:00', isParent: false, isChild: true, closedTime: '2025-09-30 12:30', slaSuccess: true, description: 'Patch deployed successfully for CVE-2025-001.', timeline: [
                { date: '2025-09-30 08:00', user: 'Security Team', action: 'Child ticket created to track GT4U-specific patch.'},
                { date: '2025-09-30 12:30', user: 'M. H.', action: 'Patch deployed and verified. Ticket closed.'}
            ]},
            { id: 'GT-1024', sid: 'SID-83749201', cid: 'CID-583921', subject: 'VM Performance Degradation', status: 'closed', serviceType: 'Problem', priority: 'high', company: 'Customer A', application: 'gt4u', relationship: 'Standard', date: '2025-10-01 10:00', isParent: false, isChild: false, closedTime: '2025-10-02 10:00', slaSuccess: false, description: 'Identified memory leak. Fixed by rolling back recent patch.', timeline: [
                { date: '2025-10-01 10:00', user: 'Customer A', action: 'Reported slow performance.'},
                { date: '2025-10-02 09:45', user: 'S. J.', action: 'Root cause found. Preparing rollback.'},
                { date: '2025-10-02 10:00', user: 'S. J.', action: 'Rollback complete, performance restored. Ticket closed.'}
            ]},
            { id: 'GT-1025', sid: 'SID-11223344', cid: 'CID-998877', subject: 'Database Connection Timeout', status: 'closed', serviceType: 'Information', priority: 'low', company: 'Customer D', application: 'gt4u', relationship: 'Standard', date: '2025-10-02 16:00', isParent: false, isChild: false, closedTime: '2025-10-03 09:00', slaSuccess: true, description: 'Confirmed transient issue. Increased connection pool size.', timeline: [
                { date: '2025-10-03 09:00', user: 'DevOps Team', action: 'Configuration updated. Closing ticket.'}
            ]},
            { id: 'GT-1026', sid: 'SID-55667788', cid: 'CID-112233', subject: 'New Customer Onboarding: Project Alpha', status: 'open', serviceType: 'Request', priority: 'low', company: 'Customer E', application: 'gt4u', relationship: 'Standard', date: '2025-10-03 11:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Initial setup of network infrastructure for Project Alpha.', timeline: [
                { date: '2025-10-03 11:00', user: 'Sales Team', action: 'New onboarding ticket created.'}
            ]},
            { id: 'JC-0045', sid: 'SID-83749201', cid: 'CID-583921', subject: 'Cloud VM CPU Spike', status: 'progress', serviceType: 'Problem', priority: 'high', company: 'Customer A', application: 'jira-cloud', relationship: 'Child', date: '2025-09-29 10:30', isParent: false, isChild: true, closedTime: null, slaSuccess: false, description: 'High CPU usage observed. Investigating potential rogue process.', timeline: [
                { date: '2025-09-29 10:30', user: 'Parent Ticket GT-0987', action: 'Child ticket created to address Cloud VM issue.'},
                { date: '2025-09-29 10:45', user: 'Cloud Team', action: 'Starting diagnostics on the affected VM instance.'}
            ]},
            { id: 'JC-0046', sid: 'SID-45678901', cid: 'CID-887432', subject: 'Fortigate Policy Review', status: 'closed', serviceType: 'Request', priority: 'medium', company: 'Customer C', application: 'jira-cloud', relationship: 'Standard', date: '2025-10-01 15:00', isParent: false, isChild: false, closedTime: '2025-10-02 11:00', slaSuccess: true, description: 'Policy review completed and new rules applied.', timeline: [
                { date: '2025-10-02 11:00', user: 'P. L.', action: 'Rules applied and verified. Ticket Closed.'}
            ]},
            { id: 'JC-0047', sid: 'SID-23948105', cid: 'CID-234512', subject: 'Load Balancer Configuration Change', status: 'open', serviceType: 'Request', priority: 'medium', company: 'Customer B', application: 'jira-cloud', relationship: 'Standard', date: '2025-10-02 09:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Request to modify LB session persistence settings.', timeline: [
                { date: '2025-10-02 09:00', user: 'Customer B', action: 'New request submitted.'}
            ]},
            { id: 'JC-0048', sid: 'SID-83749201', cid: 'CID-583921', subject: 'VM Instance Creation Request', status: 'closed', serviceType: 'Request', priority: 'low', company: 'Customer A', application: 'jira-cloud', relationship: 'Standard', date: '2025-10-02 14:00', isParent: false, isChild: false, closedTime: '2025-10-03 14:00', slaSuccess: false, description: 'New VM created for testing environment.', timeline: [
                { date: '2025-10-03 14:00', user: 'Automation Script', action: 'VM created and details sent to customer. Ticket Closed.'}
            ]},
            { id: 'JC-0050', sid: 'SID-45678901', cid: 'CID-887432', subject: 'Cloud Service Monitoring Setup', status: 'progress', serviceType: 'Information', priority: 'medium', company: 'Customer C', application: 'jira-cloud', relationship: 'Standard', date: '2025-10-03 08:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Implementing new Azure Monitor dashboards.', timeline: [
                { date: '2025-10-03 08:00', user: 'Project Manager', action: 'Task created for monitoring setup.'}
            ]},
            { id: 'JCB-010', sid: 'SID-45678901', cid: 'CID-887432', subject: 'Web App Security Audit', status: 'progress', serviceType: 'Problem', priority: 'medium', company: 'Customer C', application: 'jira-cbe', relationship: 'Standard', date: '2025-09-28 16:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Security audit in progress for main company web application.', timeline: [
                { date: '2025-09-28 16:00', user: 'Security Team', action: 'Scheduled audit started.'}
            ]},
            { id: 'JCB-011', sid: 'SID-83749201', cid: 'CID-583921', subject: 'Firewall Rule Adjustment', status: 'closed', serviceType: 'Request', priority: 'low', company: 'Customer A', application: 'jira-cbe', relationship: 'Child', date: '2025-09-30 11:00', isParent: false, isChild: true, closedTime: '2025-10-01 11:00', slaSuccess: true, description: 'Opened port 8080 for temporary access.', timeline: [
                 { date: '2025-09-30 11:00', user: 'Parent Ticket GT-0987', action: 'Child ticket created to adjust firewall rules.'},
                 { date: '2025-10-01 11:00', user: 'CBE Team', action: 'Rules implemented and tested. Ticket Closed.'}
            ]},
            { id: 'JCB-012', sid: 'SID-45678901', cid: 'CID-887432', subject: 'Vulnerability Scan Report', status: 'open', serviceType: 'Information', priority: 'low', company: 'Customer C', application: 'jira-cbe', relationship: 'Standard', date: '2025-10-01 10:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Generated weekly vulnerability scan report. No critical findings.', timeline: [
                { date: '2025-10-01 10:00', user: 'System', action: 'Report generated and attached.'}
            ]},
            { id: 'JCB-013', sid: 'SID-23948105', cid: 'CID-234512', subject: 'New WAF Policy Implementation', status: 'closed', serviceType: 'Request', priority: 'medium', company: 'Customer B', application: 'jira-cbe', relationship: 'Standard', date: '2025-10-02 12:00', isParent: false, isChild: false, closedTime: '2025-10-03 12:00', slaSuccess: true, description: 'Deployed new custom WAF rule to block suspicious IPs.', timeline: [
                { date: '2025-10-03 12:00', user: 'CBE Team', action: 'Policy deployed. Ticket Closed.'}
            ]},
            { id: 'JCB-014', sid: 'SID-83749201', cid: 'CID-583921', subject: 'Security Policy Update', status: 'open', serviceType: 'Information', priority: 'high', company: 'Customer A', application: 'jira-cbe', relationship: 'Standard', date: '2025-10-03 14:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Policy requires update due to new compliance regulations.', timeline: [
                { date: '2025-10-03 14:00', user: 'Compliance Officer', action: 'Ticket opened for policy review.'}
            ]},
            { id: 'CU-080', sid: 'SID-83749201', cid: 'CID-583921', subject: 'ERP Module A Bug Fix', status: 'progress', serviceType: 'Problem', priority: 'high', company: 'Customer A', application: 'clickup', relationship: 'Child', date: '2025-09-30 09:30', isParent: false, isChild: true, closedTime: null, slaSuccess: false, description: 'Bug reported in payroll module calculation. Debugging in progress.', timeline: [
                { date: '2025-09-30 09:30', user: 'Parent Ticket GT-0987', action: 'Child ticket created to track ERP bug.'},
                { date: '2025-09-30 10:00', user: 'Dev Team', action: 'Bug acknowledged. Investigation started.'}
            ]},
            { id: 'CU-081', sid: 'SID-23948105', cid: 'CID-234512', subject: 'CRM Dashboard Customization', status: 'closed', serviceType: 'Request', priority: 'medium', company: 'Customer B', application: 'clickup', relationship: 'Standard', date: '2025-10-01 13:00', isParent: false, isChild: false, closedTime: '2025-10-02 13:00', slaSuccess: true, description: 'Custom sales pipeline view implemented in CRM.', timeline: [
                { date: '2025-10-02 13:00', user: 'BNG Consultant', action: 'Customization complete. Ticket Closed.'}
            ]},
            { id: 'CU-082', sid: 'SID-83749201', cid: 'CID-583921', subject: 'App Integration Testing', status: 'open', serviceType: 'Information', priority: 'low', company: 'Customer A', application: 'clickup', relationship: 'Standard', date: '2025-10-02 10:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Testing phase for new marketing automation integration.', timeline: [
                 { date: '2025-10-02 10:00', user: 'QA Team', action: 'Testing task created.'}
            ]},
            { id: 'CU-083', sid: 'SID-23948105', cid: 'CID-234512', subject: 'User Training Session Schedule', status: 'closed', serviceType: 'Information', priority: 'low', company: 'Customer B', application: 'clickup', relationship: 'Standard', date: '2025-10-03 11:00', isParent: false, isChild: false, closedTime: '2025-10-03 15:00', slaSuccess: true, description: 'Training scheduled for the new HR module rollout.', timeline: [
                { date: '2025-10-03 15:00', user: 'Training Coordinator', action: 'Session scheduled. Ticket Closed.'}
            ]},
            { id: 'CU-084', sid: 'SID-45678901', cid: 'CID-887432', subject: 'ERP Reporting Issue', status: 'open', serviceType: 'Problem', priority: 'high', company: 'Customer C', application: 'clickup', relationship: 'Standard', date: '2025-10-03 16:00', isParent: false, isChild: false, closedTime: null, slaSuccess: false, description: 'Error generating quarterly financial report in ERP.', timeline: [
                { date: '2025-10-03 16:00', user: 'Customer C', action: 'Reported issue with financial reports.'}
            ]},
        ];
        
        const relationshipData = [
            {
                parent: masterTicketData[0], // GT-0987
                children: [
                    masterTicketData[7],  // JC-0045
                    masterTicketData[13], // JCB-011
                    masterTicketData[17]  // CU-080
                ]
            }
        ];

        // --- Core Functions ---
        
        function buildRelationshipMap() {
            relationshipData.forEach(rel => {
                const parentId = rel.parent.id;
                relationshipMap[parentId] = {
                    type: 'Parent',
                    children: rel.children.map(c => ({ id: c.id, application: c.application, name: applicationNames[c.application] }))
                };
                rel.children.forEach(child => {
                    relationshipMap[child.id] = {
                        type: 'Child',
                        parent: { id: parentId, application: rel.parent.application, name: applicationNames[rel.parent.application] }
                    };
                });
            });
        }

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove('active');
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            const currentTab = document.getElementById(tabName);
            if (currentTab) {
                currentTab.style.display = "block";
                currentTab.classList.add("active");
            }
            if (evt) {
                evt.currentTarget.classList.add("active");
            }
            if (tabName === 'dashboard-search') {
                const searchInput = document.getElementById('universalSearch');
                const filterApp = document.getElementById('appFilter');
                if (searchInput.value || filterApp.value !== 'all' || document.querySelector('.master-ticket-table-container').style.display !== 'none') {
                    filterAllTickets();
                } else {
                    resetDashboard(); // Call reset to ensure a clean state
                }
            } else if (tabName === 'relationships') {
                filterRelationshipTable();
            } else if (applicationNames[tabName]) {
                renderAppTabContent(tabName);
            }
        }
        
        function calculateStatsAndChartData(data) {
            const overallStats = {
                totalTickets: data.length, open: 0, progress: 0, closed: 0, slaSuccess: 0, slaFailure: 0, slaPercentage: 0
            };
            const pendingByApp = {
                gt4u: { total: 0, pending: 0, name: 'GT4U (Connecting)', color: pendingColors.gt4u, icon: 'fas fa-globe' },
                'jira-cloud': { total: 0, pending: 0, name: 'JIRA (CLOUD HM)', color: pendingColors['jira-cloud'], icon: 'fas fa-cloud' },
                'jira-cbe': { total: 0, pending: 0, name: 'JIRA (CBE)', color: pendingColors['jira-cbe'], icon: 'fas fa-shield-alt' },
                'clickup': { total: 0, pending: 0, name: 'ClickUp (BNG)', color: pendingColors.clickup, icon: 'fas fa-lightbulb' }
            };
            data.forEach(ticket => {
                if (ticket.status === 'open') {
                    overallStats.open++;
                    if(pendingByApp[ticket.application]) pendingByApp[ticket.application].pending++;
                } else if (ticket.status === 'progress') {
                    overallStats.progress++;
                    if(pendingByApp[ticket.application]) pendingByApp[ticket.application].pending++;
                } else if (ticket.status === 'closed') {
                    overallStats.closed++;
                }
                if (ticket.closedTime) { 
                    if (ticket.slaSuccess) {
                        overallStats.slaSuccess++;
                    } else {
                        overallStats.slaFailure++;
                    }
                }
                if(pendingByApp[ticket.application]) pendingByApp[ticket.application].total++;
            });
            const totalClosed = overallStats.closed;
            overallStats.slaPercentage = totalClosed > 0 ? ((overallStats.slaSuccess / totalClosed) * 100).toFixed(2) : 'N/A';
            overallStats.pending = overallStats.open + overallStats.progress;
            return { overallStats, pendingByApp };
        }

        function renderOverallStats(stats, pendingByApp) {
            const overallContent = document.getElementById('overall-stats-content');
            const pendingContent = document.getElementById('pending-ticket-summary');
            overallContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card total"><div class="stat-label">Tickets ทั้งหมด (Total)</div><div class="stat-value">${stats.totalTickets}</div></div>
                    <div class="stat-card open"><div class="stat-label">ตั๋ว Open</div><div class="stat-value">${stats.open}</div></div>
                    <div class="stat-card progress"><div class="stat-label">ตั๋ว In Progress</div><div class="stat-value">${stats.progress}</div></div>
                    <div class="stat-card closed"><div class="stat-label">ตั๋ว Closed</div><div class="stat-value">${stats.closed}</div></div>
                    <div class="stat-card percentage"><div class="stat-label">SLA Success Rate (Closed)</div><div class="stat-value">${stats.slaPercentage !== 'N/A' ? stats.slaPercentage + '%' : 'N/A'}</div></div>
                </div>`;
            pendingContent.innerHTML = '';
            Object.values(pendingByApp).forEach(app => {
                if (app.total > 0) {
                    pendingContent.innerHTML += `<div class="pending-card" style="background: ${app.color};"><div class="stat-label"><i class="${app.icon}"></i> ${app.name}</div><div class="stat-value">${app.pending} / ${app.total}</div><div class="stat-label" style="margin-top: 10px; font-size: 0.8em; opacity: 0.8;">Pending / Total</div></div>`;
                }
            });
        }
        
        function getGrandTotalCircuitSummary() {
            const grandTotal = {
                'gt4u': { appName: applicationNames['gt4u'], total: 0, service: {} },
                'jira-cloud': { appName: applicationNames['jira-cloud'], total: 0, service: {} },
                'jira-cbe': { appName: applicationNames['jira-cbe'], total: 0, service: {} },
                'clickup': { appName: applicationNames['clickup'], total: 0, service: {} }
            };
            Object.values(circuitSummaryData).forEach(customerData => {
                Object.keys(customerData).forEach(appKey => {
                    const app = customerData[appKey];
                    if (grandTotal[appKey]) {
                        grandTotal[appKey].total += app.total;
                        Object.keys(app.service).forEach(serviceName => {
                            grandTotal[appKey].service[serviceName] = (grandTotal[appKey].service[serviceName] || 0) + app.service[serviceName];
                        });
                    }
                });
            });
            return grandTotal;
        }

        function renderCircuitSummary(customerName) {
            const summaryTitle = document.getElementById('circuit-summary-title');
            const summarySection = document.getElementById('circuit-summary-section');
            let displayCustomerName, summaryData;
            if (customerName) {
                summaryData = circuitSummaryData[customerName];
                displayCustomerName = customerName;
            } else {
                summaryData = getGrandTotalCircuitSummary();
                displayCustomerName = 'All Customers (รวมทุกบริษัท)';
            }
            if (!summaryData || Object.keys(summaryData).length === 0) {
                summaryTitle.style.display = 'none';
                summarySection.style.display = 'none';
                summarySection.innerHTML = '';
                return;
            }
            summaryTitle.style.display = 'flex';
            document.getElementById('current-customer-name').textContent = displayCustomerName;
            summarySection.style.display = 'block';
            let html = '<div class="circuit-apps-grid">';
            Object.keys(summaryData).forEach(appKey => {
                const app = summaryData[appKey];
                const cardClass = appKey.replace(/-/g, '');
                let serviceListHtml = '<ul class="circuit-service-list">';
                const servicesToShow = Object.entries(app.service).filter(([, count]) => count > 0).sort((a, b) => b[1] - a[1]);
                servicesToShow.forEach(([serviceName, serviceCount]) => {
                    serviceListHtml += `<li><span>${serviceName}</span><strong>${serviceCount}</strong></li>`;
                });
                serviceListHtml += '</ul>';
                html += `<div class="circuit-card ${cardClass}"><h4>${app.appName}</h4><div class="circuit-total">${app.total}</div>${serviceListHtml}</div>`;
            });
            html += '</div>';
            summarySection.innerHTML = html;
        }

        function filterTickets() {
            const searchVal = document.getElementById('universalSearch').value.toLowerCase();
            const appVal = document.getElementById('appFilter').value;
            const startDateVal = document.getElementById('startDate').value;
            const endDateVal = document.getElementById('endDate').value;
            let customerName = null;
            if (searchVal.includes('customer a')) customerName = 'Customer A';
            else if (searchVal.includes('customer b')) customerName = 'Customer B';
            else if (searchVal.includes('customer c')) customerName = 'Customer C';
            renderCircuitSummary(customerName);
            return masterTicketData.filter(ticket => {
                const matchSearch = !searchVal || ticket.id.toLowerCase().includes(searchVal) || ticket.subject.toLowerCase().includes(searchVal) || ticket.company.toLowerCase().includes(searchVal);
                const matchApp = appVal === 'all' || ticket.application === appVal;
                const ticketDate = new Date(ticket.date.split(' ')[0]);
                const matchStartDate = !startDateVal || ticketDate >= new Date(startDateVal);
                const matchEndDate = !endDateVal || ticketDate <= new Date(endDateVal);
                return matchSearch && matchApp && matchStartDate && matchEndDate;
            });
        }
        
        function createHierarchicalList(data) {
            const hierarchicalList = [];
            const childTicketsToExclude = new Set();
            const filteredIds = new Set(data.map(t => t.id));
            data.filter(t => relationshipMap[t.id] && relationshipMap[t.id].type === 'Parent').forEach(parent => {
                hierarchicalList.push(parent);
                const parentChildren = relationshipMap[parent.id]?.children || [];
                parentChildren.forEach(childRef => {
                    if (filteredIds.has(childRef.id)) {
                        const childTicket = data.find(t => t.id === childRef.id);
                        hierarchicalList.push({ ...childTicket, isChildOfParent: true }); 
                        childTicketsToExclude.add(childTicket.id);
                    }
                });
            });
            data.filter(t => !childTicketsToExclude.has(t.id)).forEach(ticket => {
                if (!(relationshipMap[ticket.id]?.type === 'Parent')) {
                    hierarchicalList.push(ticket);
                }
            });
            return hierarchicalList;
        }

        function renderTicketTable(data, tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 30px; color: #7f8c7d;">ไม่พบข้อมูลตั๋วตามเงื่อนไขที่ค้นหา</td></tr>`;
                return;
            }
            const table = tbody.closest('table');
            const colCount = table.querySelector('thead tr').children.length;
            data.forEach(ticket => {
                const statusClass = `status-${ticket.status}`;
                const priorityClass = `priority-${ticket.priority}`;
                const serviceTypeClass = `servicetype-${ticket.serviceType}`;
                const relationshipInfo = relationshipMap[ticket.id]; 
                let relationshipIcon = '', relationshipText = 'Standard';
                if (relationshipInfo) {
                    relationshipText = relationshipInfo.type;
                    if (relationshipInfo.type === 'Parent') relationshipIcon = '<i class="fas fa-sitemap" title="Parent Ticket" style="color:#667eea;"></i>';
                    else if (relationshipInfo.type === 'Child') relationshipIcon = '<i class="fas fa-link" title="Child Ticket" style="color:#f7a518;"></i>';
                } else {
                    relationshipIcon = '<i class="fas fa-minus-circle" title="Standard Ticket" style="color:#7f8c8d;"></i>';
                }
                const isNestedChild = ticket.isChildOfParent;
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.setAttribute('data-ticket-id', ticket.id);
                row.setAttribute('data-app', ticket.application);
                if (isNestedChild) row.className += ' nested-child-row';
                let innerHtml = '';
                if (colCount === 8) {
                    innerHtml = `<td>${ticket.id}</td><td>${ticket.subject}</td><td>${ticket.company}</td><td>${applicationNames[ticket.application] || ticket.application}</td><td><span class="servicetype-badge ${serviceTypeClass}">${ticket.serviceType}</span></td><td><span class="status-badge ${statusClass}">${ticket.status}</span></td><td><span class="priority-badge ${priorityClass}">${ticket.priority}</span></td><td>${relationshipIcon} ${relationshipText}</td>`;
                } else if (colCount === 7) {
                    innerHtml = `<td>${ticket.id}</td><td>${ticket.subject}</td><td>${ticket.company}</td><td><span class="servicetype-badge ${serviceTypeClass}">${ticket.serviceType}</span></td><td><span class="status-badge ${statusClass}">${ticket.status}</span></td><td><span class="priority-badge ${priorityClass}">${ticket.priority}</span></td><td>${relationshipIcon} ${relationshipText}</td>`;
                }
                row.innerHTML = innerHtml;
                if (isNestedChild && tableBodyId === 'universalTicketTableBody') {
                    const firstCell = row.querySelector('td:first-child');
                    if (firstCell) {
                        firstCell.style.paddingLeft = '30px';
                        firstCell.innerHTML = `<i class="fas fa-level-up-alt fa-rotate-90" style="color: #667eea; margin-right: 8px;"></i>` + firstCell.innerHTML;
                    }
                }
                tbody.appendChild(row);
            });
        }

        function filterAllTickets() {
            const filteredData = filterTickets();
            const hierarchicalData = createHierarchicalList(filteredData);
            document.querySelector('.master-ticket-table-container').style.display = 'block';
            renderTicketTable(hierarchicalData, 'universalTicketTableBody');
            const { overallStats, pendingByApp } = calculateStatsAndChartData(filteredData);
            renderOverallStats(overallStats, pendingByApp);
            renderApplicationPerformanceCharts(filteredData);
            renderSlaPieCharts(filteredData);
            renderDashboardRelationshipCharts(filteredData);
        }

        // --- MODIFIED FUNCTION resetDashboard ---
        function resetDashboard() {
            document.getElementById('universalSearch').value = '';
            document.getElementById('appFilter').value = 'all';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            document.querySelector('.master-ticket-table-container').style.display = 'none';

            const allData = masterTicketData; 
            
            const { overallStats, pendingByApp } = calculateStatsAndChartData(allData);
            renderOverallStats(overallStats, pendingByApp);
            
            renderCircuitSummary(null); 
            
            renderApplicationPerformanceCharts(allData);
            renderSlaPieCharts(allData);
            renderDashboardRelationshipCharts(allData);
        }
        
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }
        
        // --- MODIFIED FUNCTION renderApplicationPerformanceCharts for Stacked Bar ---
        function renderApplicationPerformanceCharts(data) {
            destroyChart('ticketCountChart');
            destroyChart('overallSlaPieChart');
            
            // Data Aggregation for Stacked Bar Chart
            const appStatusCounts = data.reduce((acc, ticket) => {
                const app = applicationNames[ticket.application] || ticket.application;
                if (!acc[app]) {
                    acc[app] = { open: 0, progress: 0, closed: 0 };
                }
                if (ticket.status === 'open' || ticket.status === 'progress' || ticket.status === 'closed') {
                    acc[app][ticket.status]++;
                }
                return acc;
            }, {});

            const labels = Object.keys(appStatusCounts);
            const openData = labels.map(label => appStatusCounts[label].open);
            const progressData = labels.map(label => appStatusCounts[label].progress);
            const closedData = labels.map(label => appStatusCounts[label].closed);

            // Stacked Bar Chart: Ticket Count by Application
            const ticketCountCtx = document.getElementById('ticketCountChart').getContext('2d');
            chartInstances['ticketCountChart'] = new Chart(ticketCountCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Open', data: openData, backgroundColor: chartColors.open },
                        { label: 'In Progress', data: progressData, backgroundColor: chartColors.progress },
                        { label: 'Closed', data: closedData, backgroundColor: chartColors.closed }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: { mode: 'index', intersect: false },
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
            
            // Overall SLA Pie Chart
            const closedTickets = data.filter(t => t.status === 'closed');
            const slaSuccessCount = closedTickets.filter(t => t.slaSuccess).length;
            const slaFailureCount = closedTickets.length - slaSuccessCount;
            const overallSlaCtx = document.getElementById('overallSlaPieChart').getContext('2d');
            chartInstances['overallSlaPieChart'] = new Chart(overallSlaCtx, {
                type: 'doughnut',
                data: {
                    labels: ['SLA Success', 'SLA Failure'],
                    datasets: [{ data: [slaSuccessCount, slaFailureCount], backgroundColor: [chartColors.slaSuccess, chartColors.slaFailure], hoverOffset: 10 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
        
        function renderSlaPieCharts(data) {
            const slaSection = document.getElementById('sla-pie-charts-section');
            slaSection.innerHTML = '';
            Object.keys(applicationNames).forEach(appKey => {
                const appId = appKey.replace(/-/g, '');
                const appData = data.filter(t => t.application === appKey && t.status === 'closed');
                const success = appData.filter(t => t.slaSuccess).length;
                const failure = appData.length - success;
                if (appData.length === 0) return;
                const chartId = `slaPieChart-${appId}`;
                const container = document.createElement('div');
                container.className = 'chart-container';
                container.innerHTML = `<h2 class="chart-title"><i class="fas fa-chart-pie"></i> ${applicationNames[appKey]}</h2><div class="chart-wrapper"><canvas id="${chartId}"></canvas></div>`;
                slaSection.appendChild(container);
                destroyChart(chartId);
                const ctx = document.getElementById(chartId).getContext('2d');
                chartInstances[chartId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Success', 'Failure'],
                        datasets: [{ data: [success, failure], backgroundColor: [slaColorsByApp[appId].success, slaColorsByApp[appId].failure], hoverOffset: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            });
        }
        
        function renderDashboardRelationshipCharts(data) {
            destroyChart('dashboardParentTicketChart');
            destroyChart('dashboardChildDistributionChart');
            const parentTickets = data.filter(t => relationshipMap[t.id]?.type === 'Parent');
            const parentAppCounts = parentTickets.reduce((acc, ticket) => {
                const app = applicationNames[ticket.application] || ticket.application;
                acc[app] = (acc[app] || 0) + 1;
                return acc;
            }, {});
            const childTickets = data.filter(t => relationshipMap[t.id]?.type === 'Child');
            const childAppCounts = childTickets.reduce((acc, ticket) => {
                const app = applicationNames[ticket.application] || ticket.application;
                acc[app] = (acc[app] || 0) + 1;
                return acc;
            }, {});
            const parentChartCtx = document.getElementById('dashboardParentTicketChart').getContext('2d');
            if (parentTickets.length > 0) {
                chartInstances['dashboardParentTicketChart'] = new Chart(parentChartCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(parentAppCounts),
                        datasets: [{
                            data: Object.values(parentAppCounts),
                            backgroundColor: Object.keys(parentAppCounts).map(label => chartColors[Object.keys(applicationNames).find(k => applicationNames[k] === label).replace(/-/g, '')]),
                            hoverOffset: 10
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            } else {
                parentChartCtx.canvas.parentNode.innerHTML = '<div style="text-align:center; padding: 20px;">ไม่พบ Parent tickets ในข้อมูลที่กรอง</div>';
            }
            const childChartCtx = document.getElementById('dashboardChildDistributionChart').getContext('2d');
            if (childTickets.length > 0) {
                chartInstances['dashboardChildDistributionChart'] = new Chart(childChartCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(childAppCounts),
                        datasets: [{
                            label: 'Number of Child Tickets',
                            data: Object.values(childAppCounts),
                            backgroundColor: Object.keys(childAppCounts).map(label => chartColors[Object.keys(applicationNames).find(k => applicationNames[k] === label).replace(/-/g, '')]),
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            } else {
                childChartCtx.canvas.parentNode.innerHTML = '<div style="text-align:center; padding: 20px;">ไม่พบ Child tickets ในข้อมูลที่กรอง</div>';
            }
        }

        // --- MODIFIED FUNCTION TO DISPLAY SID AND CID ---
        function renderTicketDetails(ticket, colspan) {
            const closedTimeHtml = ticket.closedTime ? `<span style="color: #28a745; font-weight: 700;">${ticket.closedTime}</span>` : '<span style="color: #dc3545; font-weight: 700;">N/A (Still Open)</span>';
            const slaHtml = ticket.closedTime ? (ticket.slaSuccess ? '<span class="status-badge status-closed">Success (4h)</span>' : '<span class="status-badge status-open">Failure (4h)</span>') : '<span class="status-badge status-progress">Pending</span>';
            const relationshipInfo = relationshipMap[ticket.id];
            let relationshipHtml = '';
            if (relationshipInfo?.type === 'Parent') {
                const childListHtml = relationshipInfo.children.length > 0 ? relationshipInfo.children.map(c => `<li><i class="fas fa-link" style="color:#f7a518;"></i> <strong>${c.id}</strong> (${c.name})</li>`).join('') : '<li><i class="fas fa-minus-circle" style="color:#7f8c8d;"></i> ไม่มี Child Ticket ในระบบ</li>';
                relationshipHtml = `<div class="detail-item" style="grid-column: span 3;"><strong>Child Tickets (${relationshipInfo.children.length} รายการ)</strong><ul style="list-style: none; padding-left: 0; margin-top: 5px; font-size: 0.95em;">${childListHtml}</ul></div>`;
            } else if (relationshipInfo?.type === 'Child') {
                const parent = relationshipInfo.parent;
                relationshipHtml = `<div class="detail-item"><strong><i class="fas fa-sitemap" style="color:#667eea;"></i> Parent Ticket ID</strong><span style="color: #667eea; font-weight: 700;">${parent.id}</span></div><div class="detail-item"><strong>Parent Application</strong><span>${parent.name}</span></div>`;
            } else {
                relationshipHtml = `<div class="detail-item"><strong>Ticket Relationship</strong><span>Standalone (ไม่มีความสัมพันธ์)</span></div>`;
            }
            let timelineHtml = '';
            if (ticket.timeline && ticket.timeline.length > 0) {
                const timelineItems = ticket.timeline.map(item => `<div class="timeline-item"><div class="timeline-time">${item.date}</div><div class="timeline-action">${item.action}</div><div class="timeline-user"><i class="fas fa-user"></i> ผู้ดำเนินการ: ${item.user}</div></div>`).join('');
                timelineHtml = `<div style="grid-column: 1 / -1;"><h5 class="timeline-title"><i class="fas fa-history"></i> Progressive Timeline History</h5><div class="timeline-container">${timelineItems}</div></div>`;
            }
            return `<tr class="detail-row" data-detail-for="${ticket.id}"><td colspan="${colspan}"><div class="ticket-details-container"><div class="details-summary"><h4 style="color: #667eea;">Ticket ID: ${ticket.id} (${applicationNames[ticket.application]})</h4><button onclick="hideTicketDetail(this)" style="background: none; border: none; color: #dc3545; font-weight: 700; cursor: pointer;"><i class="fas fa-times-circle"></i> ปิดรายละเอียด</button></div>
                        <div class="details-content-grid">
                            <div class="detail-item"><strong>Ticket ID</strong><span>${ticket.id}</span></div>
                            <div class="detail-item"><strong>Application</strong><span>${applicationNames[ticket.application]}</span></div>
                            <div class="detail-item"><strong>SID</strong><span>${ticket.sid || 'N/A'}</span></div>
                            <div class="detail-item"><strong>CID</strong><span>${ticket.cid || 'N/A'}</span></div>
                            <div class="detail-item"><strong>Company</strong><span>${ticket.company}</span></div>
                            <div class="detail-item"><strong>Created Date</strong><span>${ticket.date}</span></div>
                            <div class="detail-item"><strong>Closed Date</strong>${closedTimeHtml}</div>
                            <div class="detail-item"><strong>SLA Status</strong>${slaHtml}</div>
                            ${relationshipHtml}
                            <div class="detail-item" style="grid-column: 1 / -1;"><strong>Description (Simulated)</strong><span>${ticket.description || 'No description available.'}</span></div>
                            ${timelineHtml}
                        </div></div></td></tr>`;
        }

        function hideTicketDetail(buttonElement) {
            const detailRow = buttonElement.closest('.detail-row');
            if (detailRow) {
                const ticketId = detailRow.getAttribute('data-detail-for');
                const dataRow = document.querySelector(`.clickable-row[data-ticket-id="${ticketId}"]`);
                if (dataRow) dataRow.classList.remove('active-row');
                detailRow.remove();
            }
        }

        function handleDataRowClick(event) {
            let target = event.target.closest('.clickable-row');
            if (target && !event.target.closest('.clickable-child-id')) {
                const ticketId = target.getAttribute('data-ticket-id');
                const ticket = masterTicketData.find(t => t.id === ticketId);
                if (!ticket) return;
                const table = target.closest('table');
                const colspan = table.querySelector('thead tr').children.length;
                const isDetailOpen = target.nextElementSibling?.classList.contains('detail-row');
                table.querySelectorAll('.detail-row').forEach(row => row.remove());
                table.querySelectorAll('.active-row').forEach(row => row.classList.remove('active-row'));
                if (!isDetailOpen) {
                    target.classList.add('active-row');
                    target.insertAdjacentHTML('afterend', renderTicketDetails(ticket, colspan));
                }
            }
        }
        
        function handleRelationshipTableClick(event) {
            const childIdSpan = event.target.closest('.clickable-child-id');
            if (childIdSpan) {
                const ticketId = childIdSpan.getAttribute('data-ticket-id');
                const ticket = masterTicketData.find(t => t.id === ticketId);
                const parentRow = childIdSpan.closest('.clickable-row');
                if (ticket && parentRow) {
                    const table = parentRow.closest('table');
                    const colspan = table.querySelector('thead tr').children.length;
                    const isDetailOpen = parentRow.nextElementSibling?.getAttribute('data-detail-for') === ticketId;
                    table.querySelectorAll('.detail-row').forEach(row => row.remove());
                    table.querySelectorAll('.active-row').forEach(row => row.classList.remove('active-row'));
                    if (!isDetailOpen) {
                        parentRow.classList.add('active-row');
                        parentRow.insertAdjacentHTML('afterend', renderTicketDetails(ticket, colspan));
                    }
                }
            }
        }

        function filterRelationshipTable() {
            const searchVal = document.getElementById('relationshipSearch').value.toLowerCase();
            const appVal = document.getElementById('relationshipAppFilter').value;
            const startDateVal = document.getElementById('relationshipStartDate').value;
            const endDateVal = document.getElementById('relationshipEndDate').value;
            const filteredParents = relationshipData.filter(rel => {
                const parent = rel.parent;
                const matchSearch = !searchVal || parent.id.toLowerCase().includes(searchVal) || parent.subject.toLowerCase().includes(searchVal);
                const matchApp = appVal === 'all' || parent.application === appVal;
                const ticketDate = new Date(parent.date.split(' ')[0]);
                const matchStartDate = !startDateVal || ticketDate >= new Date(startDateVal);
                const matchEndDate = !endDateVal || ticketDate <= new Date(endDateVal);
                return matchSearch && matchApp && matchStartDate && matchEndDate;
            });
            renderRelationshipTable(filteredParents);
            const allRelatedTickets = filteredParents.flatMap(r => [r.parent, ...r.children]);
            renderRelationshipCharts(allRelatedTickets);
        }
        
        // --- NEW FUNCTION for Relationship Reset ---
        function resetRelationshipFilter() {
            document.getElementById('relationshipSearch').value = '';
            document.getElementById('relationshipAppFilter').value = 'all';
            document.getElementById('relationshipStartDate').value = '';
            document.getElementById('relationshipEndDate').value = '';
            filterRelationshipTable();
        }

        function renderRelationshipTable(relationships) {
            const tbody = document.getElementById('relationships-table-body');
            tbody.innerHTML = '';
            if (relationships.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px; color: #7f8c7d;">ไม่พบ Parent Ticket ตามเงื่อนไขที่ค้นหา</td></tr>`;
                return;
            }
            relationships.forEach(rel => {
                const parent = rel.parent;
                const childIds = rel.children.map(c => `<span class="clickable-child-id" data-ticket-id="${c.id}" style="color:#667eea; text-decoration: underline; cursor: pointer;">${c.id}</span>`).join(', ');
                const row = document.createElement('tr');
                row.className = 'clickable-row parent-row';
                row.setAttribute('data-ticket-id', parent.id);
                row.innerHTML = `<td><strong>${parent.id}</strong>: ${parent.subject}<br><small style="color: #6c757d;">(${applicationNames[parent.application]})</small></td><td><span class="servicetype-badge servicetype-${parent.serviceType}">${parent.serviceType}</span></td><td><span class="status-badge status-${parent.status}">${parent.status}</span><span class="priority-badge priority-${parent.priority}">${parent.priority}</span></td><td>${childIds || 'ไม่มี Child Ticket'}</td>`;
                tbody.appendChild(row);
            });
        }
        
        function renderRelationshipCharts(data) {
            destroyChart('relationshipParentTicketChart');
            destroyChart('relationshipChildDistributionChart');
            const parentTickets = data.filter(t => relationshipMap[t.id]?.type === 'Parent');
            const parentAppCounts = parentTickets.reduce((acc, ticket) => {
                const app = applicationNames[ticket.application] || ticket.application;
                acc[app] = (acc[app] || 0) + 1;
                return acc;
            }, {});
            const childTickets = data.filter(t => relationshipMap[t.id]?.type === 'Child');
            const childAppCounts = childTickets.reduce((acc, ticket) => {
                const app = applicationNames[ticket.application] || ticket.application;
                acc[app] = (acc[app] || 0) + 1;
                return acc;
            }, {});
            const parentChartCtx = document.getElementById('relationshipParentTicketChart').getContext('2d');
            if (parentTickets.length > 0) {
                chartInstances['relationshipParentTicketChart'] = new Chart(parentChartCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(parentAppCounts),
                        datasets: [{ data: Object.values(parentAppCounts), backgroundColor: Object.keys(parentAppCounts).map(label => chartColors[Object.keys(applicationNames).find(k => applicationNames[k] === label).replace(/-/g, '')]), hoverOffset: 10 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            } else {
                parentChartCtx.canvas.parentNode.innerHTML = '<div style="text-align:center; padding: 20px;">ไม่พบ Parent tickets</div>';
            }
            const childChartCtx = document.getElementById('relationshipChildDistributionChart').getContext('2d');
            if (childTickets.length > 0) {
                chartInstances['relationshipChildDistributionChart'] = new Chart(childChartCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(childAppCounts),
                        datasets: [{ label: 'Number of Child Tickets', data: Object.values(childAppCounts), backgroundColor: Object.keys(childAppCounts).map(label => chartColors[Object.keys(applicationNames).find(k => applicationNames[k] === label).replace(/-/g, '')]) }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            } else {
                childChartCtx.canvas.parentNode.innerHTML = '<div style="text-align:center; padding: 20px;">ไม่พบ Child tickets</div>';
            }
        }
        
        // --- NEW/MODIFIED functions for App Tab Search/Reset ---
        function filterAppTickets(appKey) {
            const searchVal = document.getElementById(`search-${appKey}`).value.toLowerCase();
            const startDateVal = document.getElementById(`startDate-${appKey}`).value;
            const endDateVal = document.getElementById(`endDate-${appKey}`).value;

            const filteredData = masterTicketData.filter(ticket => {
                if (ticket.application !== appKey) return false;

                const matchSearch = !searchVal || 
                                    ticket.id.toLowerCase().includes(searchVal) ||
                                    ticket.subject.toLowerCase().includes(searchVal) ||
                                    ticket.company.toLowerCase().includes(searchVal);
                
                const ticketDate = new Date(ticket.date.split(' ')[0]);
                const matchStartDate = !startDateVal || ticketDate >= new Date(startDateVal);
                const matchEndDate = !endDateVal || ticketDate <= new Date(endDateVal);

                return matchSearch && matchStartDate && matchEndDate;
            });
            
            // Re-render only the ticket list for this tab
            renderAppTabTicketList(filteredData, `${appKey}-ticketTableBody`);
        }

        function resetAppFilter(appKey) {
            document.getElementById(`search-${appKey}`).value = '';
            document.getElementById(`startDate-${appKey}`).value = '';
            document.getElementById(`endDate-${appKey}`).value = '';
            filterAppTickets(appKey);
        }

        function renderAppTabTicketList(data, tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px; color: #7f8c7d;">ไม่พบข้อมูลตั๋วตามเงื่อนไขที่ค้นหา</td></tr>`;
                return;
            }
            data.forEach(ticket => {
                const relationshipInfo = relationshipMap[ticket.id]; 
                let relationshipIcon = '', relationshipText = 'Standard';
                if (relationshipInfo) {
                    relationshipText = relationshipInfo.type;
                    if (relationshipInfo.type === 'Parent') relationshipIcon = '<i class="fas fa-sitemap" title="Parent Ticket" style="color:#667eea;"></i>';
                    else if (relationshipInfo.type === 'Child') relationshipIcon = '<i class="fas fa-link" title="Child Ticket" style="color:#f7a518;"></i>';
                } else {
                    relationshipIcon = '<i class="fas fa-minus-circle" title="Standard Ticket" style="color:#7f8c8d;"></i>';
                }
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.setAttribute('data-ticket-id', ticket.id);
                row.innerHTML = `<td>${ticket.id}</td><td>${ticket.subject}</td><td>${ticket.company}</td><td><span class="servicetype-badge servicetype-${ticket.serviceType}">${ticket.serviceType}</span></td><td><span class="status-badge status-${ticket.status}">${ticket.status}</span></td><td><span class="priority-badge priority-${ticket.priority}">${ticket.priority}</span></td><td>${relationshipIcon} ${relationshipText}</td>`;
                tbody.appendChild(row);
            });
        }
        
        function renderAppTabCharts(data, appKey) {
            const appId = appKey.replace(/-/g, '');
            const appColor = chartColors[appId];
            const statusCounts = data.reduce((acc, ticket) => {
                acc[ticket.status] = (acc[ticket.status] || 0) + 1;
                return acc;
            }, {});
            const statusLabels = ['open', 'progress', 'closed'];
            const statusData = statusLabels.map(s => statusCounts[s] || 0);
            const statusBackgrounds = [chartColors.open, chartColors.progress, chartColors.closed];
            const serviceTypeCounts = data.reduce((acc, ticket) => {
                acc[ticket.serviceType] = (acc[ticket.serviceType] || 0) + 1;
                return acc;
            }, {});
            destroyChart(`${appKey}-statusChart`);
            const statusCtx = document.getElementById(`${appKey}-statusChart`)?.getContext('2d');
            if(statusCtx) {
                chartInstances[`${appKey}-statusChart`] = new Chart(statusCtx, {
                    type: 'pie',
                    data: {
                        labels: statusLabels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
                        datasets: [{ data: statusData, backgroundColor: statusBackgrounds, hoverOffset: 10 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }
            destroyChart(`${appKey}-serviceTypeChart`);
            const serviceTypeCtx = document.getElementById(`${appKey}-serviceTypeChart`)?.getContext('2d');
            if(serviceTypeCtx) {
                chartInstances[`${appKey}-serviceTypeChart`] = new Chart(serviceTypeCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(serviceTypeCounts),
                        datasets: [{ label: 'Service Type Count', data: Object.values(serviceTypeCounts), backgroundColor: appColor }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }
        }
        
        function renderAppTabContent(appKey) {
            const appTab = document.getElementById(appKey);
            const appName = applicationNames[appKey];
            const appId = appKey.replace(/-/g, '');
            const appColor = pendingColors[appKey];
            const filteredData = masterTicketData.filter(t => t.application === appKey);
            const { overallStats } = calculateStatsAndChartData(filteredData);
            
            appTab.innerHTML = `
                <h2 class="section-title"><i class="fas fa-ticket-alt"></i> ${appName} Ticket Dashboard</h2>
                <div class="filter-controls-container">
                    <h2 class="section-title"><i class="fas fa-search"></i> ค้นหา Ticket ใน ${appName}</h2>
                    <div class="filter-inputs">
                        <input type="text" id="search-${appKey}" placeholder="ค้นหาด้วย ID, Subject, หรือชื่อบริษัท" style="flex-grow: 4;"/> 
                        <input type="date" id="startDate-${appKey}" style="flex-grow: 1; max-width: 150px;" title="จากวันที่เริ่มต้น" />
                        <input type="date" id="endDate-${appKey}" style="flex-grow: 1; max-width: 150px;" title="ถึงวันที่สิ้นสุด" />
                        <button onclick="resetAppFilter('${appKey}')" style="flex-grow: 0; min-width: 80px; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">
                            <i class="fas fa-redo"></i> รีเซ็ต
                        </button>
                        <button onclick="filterAppTickets('${appKey}')" style="flex-grow: 0; min-width: 100px;">
                            <i class="fas fa-search"></i> ค้นหา
                        </button>
                    </div>
                </div>
                
                <div id="app-overall-stats-${appId}">
                    <div class="stats-grid">
                        <div class="stat-card total" style="background: ${appColor};"><div class="stat-label">Tickets ทั้งหมด (Total)</div><div class="stat-value">${overallStats.totalTickets}</div></div>
                        <div class="stat-card open"><div class="stat-label">ตั๋ว Open</div><div class="stat-value">${overallStats.open}</div></div>
                        <div class="stat-card progress"><div class="stat-label">ตั๋ว In Progress</div><div class="stat-value">${overallStats.progress}</div></div>
                        <div class="stat-card closed"><div class="stat-label">ตั๋ว Closed</div><div class="stat-value">${overallStats.closed}</div></div>
                        <div class="stat-card percentage"><div class="stat-label">SLA Success Rate (Closed)</div><div class="stat-value">${overallStats.slaPercentage !== 'N/A' ? overallStats.slaPercentage + '%' : 'N/A'}</div></div>
                    </div>
                </div>
                <h2 class="section-title" style="margin-top: 40px;"><i class="fas fa-chart-area"></i> Charts and Status Breakdown</h2>
                <div class="app-charts-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="chart-container">
                        <h2 class="chart-title"><i class="fas fa-chart-pie"></i> Status Distribution</h2>
                        <div class="chart-wrapper"><canvas id="${appKey}-statusChart"></canvas></div>
                    </div>
                     <div class="chart-container">
                        <h2 class="chart-title"><i class="fas fa-chart-bar"></i> Service Type Breakdown</h2>
                        <div class="chart-wrapper"><canvas id="${appKey}-serviceTypeChart"></canvas></div>
                    </div>
                </div>
                <div class="tickets-table-container" style="margin-top: 40px;">
                    <h3 class="section-title" style="font-size: 1.2em; border-bottom: 2px solid #ccc;"><i class="fas fa-list-ul"></i> Ticket List for ${appName}</h3>
                    <table class="tickets-table app-ticket-table">
                        <thead>
                            <tr>
                                <th>Ticket ID</th><th>Subject</th><th>Company Name</th><th>Service Type</th><th>Status</th><th>Priority</th><th>ความสัมพันธ์</th> 
                            </tr>
                        </thead>
                        <tbody id="${appKey}-ticketTableBody"></tbody>
                    </table>
                </div>`;

            renderAppTabTicketList(filteredData, `${appKey}-ticketTableBody`);
            
            setTimeout(() => {
                renderAppTabCharts(filteredData, appKey);
            }, 0);
        }

        function runInitialization() {
            buildRelationshipMap();
            const allData = masterTicketData;
            const { overallStats, pendingByApp } = calculateStatsAndChartData(allData);
            renderCircuitSummary(null);
            renderOverallStats(overallStats, pendingByApp);
            renderApplicationPerformanceCharts(allData);
            renderSlaPieCharts(allData);
            renderDashboardRelationshipCharts(allData);
            document.getElementById('universalSearch').value = '';
            document.getElementById('appFilter').value = 'all';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            const ticketTableContainer = document.querySelector('.master-ticket-table-container');
            if (ticketTableContainer) ticketTableContainer.style.display = 'none';
            const container = document.querySelector('.container');
            container.addEventListener('click', handleDataRowClick);
            const relationshipTable = document.getElementById('relationships-main-table');
            if (relationshipTable) relationshipTable.addEventListener('click', handleRelationshipTableClick);
            const defaultTab = document.getElementById('dashboard-search');
            if (defaultTab) {
                defaultTab.style.display = 'block';
                defaultTab.classList.add('active');
            }
            const defaultTabBtn = document.querySelector('.tab-btn[onclick*="dashboard-search"]');
            if (defaultTabBtn) defaultTabBtn.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', runInitialization);
    </script>
</body>
</html>
